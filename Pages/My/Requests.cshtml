@page
@model ShiftManager.Pages.My.RequestsModel
@{
    Layout = "_Layout";
}

<div style="max-width: 1000px; margin: 0 auto;">
    <h2 style="color: var(--text); margin-bottom: 2rem;">My Requests</h2>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-success" style="margin-bottom: 2rem; padding: 1rem; background: var(--success); color: white; border-radius: 0.5rem;">
            @Model.Message
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.Error))
    {
        <div class="alert alert-danger" style="margin-bottom: 2rem; padding: 1rem; background: var(--danger); color: white; border-radius: 0.5rem;">
            @Model.Error
        </div>
    }

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <!-- Time Off Request Form -->
        <div class="card" style="padding: 2rem;">
            <h3 style="color: var(--primary); margin-top: 0; margin-bottom: 1.5rem;">Request Time Off</h3>
            <form method="post" asp-page-handler="TimeOff">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" style="color: var(--danger); margin-bottom: 1rem; font-size: 0.9rem;"></div>
                <div style="margin-bottom: 1rem;">
                    <label asp-for="TimeOffRequest.StartDate" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text);">Start Date</label>
                    <input asp-for="TimeOffRequest.StartDate" type="date" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface);" />
                    <span asp-validation-for="TimeOffRequest.StartDate" style="color: var(--danger); font-size: 0.8rem;"></span>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label asp-for="TimeOffRequest.EndDate" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text);">End Date</label>
                    <input asp-for="TimeOffRequest.EndDate" type="date" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface);" />
                    <span asp-validation-for="TimeOffRequest.EndDate" style="color: var(--danger); font-size: 0.8rem;"></span>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label asp-for="TimeOffRequest.Reason" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text);">Reason</label>
                    <textarea asp-for="TimeOffRequest.Reason" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface); resize: vertical;" placeholder="Please provide a reason for your time off request..."></textarea>
                    <span asp-validation-for="TimeOffRequest.Reason" style="color: var(--danger); font-size: 0.8rem;"></span>
                </div>
                <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%;">Submit Time Off Request</button>
            </form>
        </div>

        <!-- Shift Swap Request Form -->
        <div class="card" style="padding: 2rem;">
            <h3 style="color: var(--primary); margin-top: 0; margin-bottom: 1.5rem;">Request Shift Swap</h3>
            @if (Model.AvailableShifts.Any())
            {
                <form method="post" asp-page-handler="Swap">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="All" style="color: var(--danger); margin-bottom: 1rem; font-size: 0.9rem;"></div>
                    <div style="margin-bottom: 1.5rem;">
                        <label asp-for="SwapRequest.ShiftId" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text);">Select Your Shift to Swap</label>
                        <select asp-for="SwapRequest.ShiftId" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface);">
                            <option value="0">Choose a shift...</option>
                            @foreach (var shift in Model.AvailableShifts)
                            {
                                <option value="@shift.ShiftId">@shift.Date.ToString("yyyy-MM-dd") - @shift.ShiftTypeName (@shift.StartTime.ToString("HH:mm") - @shift.EndTime.ToString("HH:mm"))</option>
                            }
                        </select>
                        <span asp-validation-for="SwapRequest.ShiftId" style="color: var(--danger); font-size: 0.8rem;"></span>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label asp-for="SwapRequest.ToUserId" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text);">Send To (optional)</label>
                        <select asp-for="SwapRequest.ToUserId" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface);">
                            <option value="">Leave request open for any teammate</option>
                            @foreach (var recipient in Model.PotentialRecipients)
                            {
                                <option value="@recipient.Id">@recipient.DisplayName (@recipient.Email)</option>
                            }
                        </select>
                        <span asp-validation-for="SwapRequest.ToUserId" style="color: var(--danger); font-size: 0.8rem;"></span>
                        <p style="color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem;">Pick a coworker if you already have someone ready to swap with you, or leave the request open so anyone (or a manager) can volunteer.</p>
                        @if (!Model.PotentialRecipients.Any())
                        {
                            <p style="color: var(--muted); font-size: 0.8rem; margin-top: 0.5rem;">No teammates available? Leaving the request open lets managers reassign it when someone becomes available.</p>
                        }
                    </div>
                    <button type="submit" style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%;">Request Shift Swap</button>
                </form>
            }
            else
            {
                <p style="color: var(--muted); text-align: center; margin: 2rem 0;">You have no upcoming shifts available for swapping.</p>
            }
        </div>
    </div>

    <!-- My Requests Status -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <!-- Time Off Requests -->
        <div class="card" style="padding: 2rem;">
            <h3 style="color: var(--text); margin-top: 0; margin-bottom: 1.5rem;">My Time Off Requests</h3>
            @if (Model.MyTimeOffRequests.Any())
            {
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 0.75rem 0; color: var(--text); font-weight: 600;">Dates</th>
                                <th style="text-align: left; padding: 0.75rem 0; color: var(--text); font-weight: 600;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.MyTimeOffRequests)
                            {
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 0.75rem 0; color: var(--text);">
                                        @request.StartDate.ToString("MMM dd") - @request.EndDate.ToString("MMM dd, yyyy")
                                        <br><small style="color: var(--muted);">@request.Reason</small>
                                    </td>
                                    <td style="padding: 0.75rem 0;">
                                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: 600;
                                            background: @(request.Status == "Pending" ? "var(--focus)" : request.Status == "Approved" ? "var(--success)" : "var(--danger)");
                                            color: white;">@request.Status</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p style="color: var(--muted); text-align: center; margin: 2rem 0;">No time off requests yet.</p>
            }
        </div>

        <!-- Swap Requests -->
        <div class="card" style="padding: 2rem;">
            <h3 style="color: var(--text); margin-top: 0; margin-bottom: 1.5rem;">My Swap Requests</h3>
            @if (Model.MySwapRequests.Any())
            {
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 0.75rem 0; color: var(--text); font-weight: 600;">Shift</th>
                                <th style="text-align: left; padding: 0.75rem 0; color: var(--text); font-weight: 600;">Recipient</th>
                                <th style="text-align: left; padding: 0.75rem 0; color: var(--text); font-weight: 600;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.MySwapRequests)
                            {
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 0.75rem 0; color: var(--text);">
                                        <strong>@request.ShiftDate.ToString("MMM dd, yyyy")</strong>
                                        <br /><small style="color: var(--muted);">@request.ShiftInstanceName</small>
                                        <br /><small style="color: var(--muted);">@request.ShiftTimeRange</small>
                                    </td>
                                    <td style="padding: 0.75rem 0; color: var(--text);">
                                        @if (request.IsOpen)
                                        {
                                            <span style="color: var(--muted);">Open to any teammate</span>
                                        }
                                        else
                                        {
                                            <span>@request.ToUserName</span>
                                            @if (!string.IsNullOrEmpty(request.ToUserEmail))
                                            {
                                                <br /><small style="color: var(--muted);">@request.ToUserEmail</small>
                                            }
                                        }
                                    </td>
                                    <td style="padding: 0.75rem 0;">
                                        <span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: 600;
                                            background: @(request.Status == "Pending" ? "var(--focus)" : request.Status == "Approved" ? "var(--success)" : "var(--danger)");
                                            color: white;">@request.Status</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p style="color: var(--muted); text-align: center; margin: 2rem 0;">No swap requests yet.</p>
            }
        </div>
    </div>
</div>

