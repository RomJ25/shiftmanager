@page
@model ShiftManager.Pages.Admin.UsersModel
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<ShiftManager.Resources.SharedResources> Localizer
@{
    Layout = "_Layout";
}
<h2>@Localizer["Users"]</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success" style="margin-bottom: 2rem; padding: 1rem; background: var(--success); color: white; border-radius: 0.5rem;">
        @TempData["SuccessMessage"]
    </div>
}

<div class="card">
    <h3 style="margin-top:0">@Localizer["AddUser"]</h3>
    @if (!string.IsNullOrEmpty(Model.Error)) { <div class="small" style="color:var(--danger)">@Model.Error</div> }
    <form method="post" asp-page-handler="Add">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:.5rem; align-items:end">
            <label>@Localizer["Email"]<br /><input class="input" asp-for="NewEmail" /></label>
            <label>@Localizer["DisplayName"]<br /><input class="input" asp-for="NewDisplayName" /></label>
            <label>@Localizer["Role"]<br />
                <select class="input" asp-for="NewRole">
                    <option>@Localizer["Employee"]</option>
                    <option>@Localizer["Manager"]</option>
                    <option>@Localizer["Admin"]</option>
                </select>
            </label>
            <label>@Localizer["Password"]<br /><input class="input" asp-for="NewPassword" type="password" /></label>
            <button class="btn btn-primary" type="submit">@Localizer["Add"]</button>
        </div>
    </form>
</div>

<div class="card">
    <h3 style="margin-top:0">@Localizer["AllUsers"]</h3>
    <table>
        <thead><tr><th>@Localizer["Name"]</th><th>@Localizer["Email"]</th><th>@Localizer["Role"]</th><th>@Localizer["Status"]</th><th style="width:1%">@Localizer["Password"]</th><th style="width:1%">@Localizer["Actions"]</th></tr></thead>
        <tbody>
        @foreach (var u in Model.Users)
        {
            <tr>
                <td>@u.DisplayName</td>
                <td>@u.Email</td>
                <td>
                    <form method="post" asp-page-handler="Role" style="display:inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@u.Id" />
                    <select class="input" name="role" onchange="this.form.submit()">
                    @if (u.Role == "Employee")
                    { <option value="Employee" selected>@Localizer["Employee"]</option> }
                    else
                    { <option value="Employee">@Localizer["Employee"]</option> }
                    @if (u.Role == "Manager")  { <option value="Manager" selected>@Localizer["Manager"]</option> }
                    else                        { <option value="Manager">@Localizer["Manager"]</option> }
                    @if (u.Role == "Admin")    { <option value="Admin" selected>@Localizer["Admin"]</option> }
                    else                        { <option value="Admin">@Localizer["Admin"]</option> }
                    </select>
                    </form>

                </td>
                <td>
                   <form method="post" asp-page-handler="Toggle" style="display:inline">
                   @Html.AntiForgeryToken()
                   <input type="hidden" name="id" value="@u.Id" />
                   <button class="btn">@((u.IsActive) ? Localizer["Active"] : Localizer["Inactive"])</button>
                   </form>
                </td>
                <td>
                    <form method="post" asp-page-handler="ResetPassword" style="display:inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@u.Id" />
                    <input class="input" type="password" name="newPassword" placeholder="@Localizer["NewPassword"]" />
                    <button class="btn btn-ghost">@Localizer["Set"]</button>
                    </form>
                </td>
                <td>
                    <form method="post" asp-page-handler="DeleteUser" style="display:inline"
                          onsubmit="return confirm('@string.Format(Localizer["UserDeletionConfirmation"], u.DisplayName)');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@u.Id" />
                        <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                            @Localizer["Delete"]
                        </button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <div style="margin-top: 1rem; padding: 1rem; background: var(--surface); border-left: 4px solid var(--danger); border-radius: 0.5rem;">
        <small style="color: var(--danger); font-weight: 600;">
            <strong>@Localizer["UserDeletionWarning"]</strong>
        </small>
        <br>
        <small style="color: var(--muted);">
            @Localizer["UserDeletionInfo"]
        </small>
    </div>
</div>
