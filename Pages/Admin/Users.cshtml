@page
@model ShiftManager.Pages.Admin.UsersModel
@{
    Layout = "_Layout";
}
<h2>Users</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success" style="margin-bottom: 2rem; padding: 1rem; background: var(--success); color: white; border-radius: 0.5rem;">
        @TempData["SuccessMessage"]
    </div>
}

<div class="card">
    <h3 style="margin-top:0">Add User</h3>
    @if (!string.IsNullOrEmpty(Model.Error)) { <div class="small" style="color:var(--danger)">@Model.Error</div> }
    <form method="post" asp-page-handler="Add">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:.5rem; align-items:end">
            <label>Email<br /><input class="input" asp-for="NewEmail" /></label>
            <label>Display name<br /><input class="input" asp-for="NewDisplayName" /></label>
            <label>Role<br />
                <select class="input" asp-for="NewRole">
                    @foreach (var role in Model.AvailableRoles)
                    {
                        <option value="@role">@role</option>
                    }
                </select>
            </label>
            <label>Password<br /><input class="input" asp-for="NewPassword" type="password" /></label>
            <button class="btn btn-primary" type="submit">Add</button>
        </div>
    </form>
</div>

<div class="card">
    <h3 style="margin-top:0">All Users</h3>
    <table>
        <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th style="width:1%">Password</th><th style="width:1%">Actions</th></tr></thead>
        <tbody>
        @foreach (var u in Model.Users)
        {
            <tr>
                <td>@u.DisplayName</td>
                <td>@u.Email</td>
                <td>
                    <form method="post" asp-page-handler="Role" style="display:inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@u.Id" />
                    <select class="input" name="role" onchange="this.form.submit()">
                    @foreach (var role in Model.AvailableRoles)
                    {
                        <option value="@role" @(u.Role == role.ToString() ? "selected" : null)>@role</option>
                    }
                    </select>
                    </form>

                </td>
                <td>
                   <form method="post" asp-page-handler="Toggle" style="display:inline">
                   @Html.AntiForgeryToken()
                   <input type="hidden" name="id" value="@u.Id" />
                   <button class="btn">@((u.IsActive) ? "Active" : "Inactive")</button>
                   </form>
                </td>
                <td>
                    <form method="post" asp-page-handler="ResetPassword" style="display:inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@u.Id" />
                    <input class="input" type="password" name="newPassword" placeholder="new password" />
                    <button class="btn btn-ghost">Set</button>
                    </form>
                </td>
                <td>
                    <form method="post" asp-page-handler="DeleteUser" style="display:inline"
                          onsubmit="return confirm('‚ö†Ô∏è WARNING: This will permanently delete @u.DisplayName and remove all their shift assignments, time-off requests, and swap requests. This action cannot be undone.\n\nAre you absolutely sure you want to delete this user?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@u.Id" />
                        <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                            üóëÔ∏è Delete
                        </button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <div style="margin-top: 1rem; padding: 1rem; background: var(--surface); border-left: 4px solid var(--danger); border-radius: 0.5rem;">
        <small style="color: var(--danger); font-weight: 600;">
            ‚ö†Ô∏è <strong>User Deletion Warning:</strong>
        </small>
        <br>
        <small style="color: var(--muted);">
            Deleting a user will permanently remove:
            ‚Ä¢ All their shift assignments (shifts will become empty)
            ‚Ä¢ All their time-off requests (approved, pending, and declined)
            ‚Ä¢ All their swap requests (both from and to the user)
            ‚Ä¢ The user account itself
            <br><br>
            <strong>This action cannot be undone. Use with extreme caution.</strong>
        </small>
    </div>
</div>
