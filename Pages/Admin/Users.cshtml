@page
@model ShiftManager.Pages.Admin.UsersModel
@using Microsoft.Extensions.Localization
@using ShiftManager.Resources
@using ShiftManager.Models.Support
@inject IStringLocalizer<SharedResources> Localizer
@{
    Layout = "_Layout";
}
<h2>@Localizer["UserManagement"]</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success" style="margin-bottom: 2rem; padding: 1rem; background: var(--success); color: white; border-radius: 0.5rem;">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger" style="margin-bottom: 2rem; padding: 1rem; background: var(--danger); color: white; border-radius: 0.5rem;">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Join Requests Section -->
<div class="card">
    <h3 style="margin-top:0">@Localizer["JoinRequests"]</h3>

    <!-- Filters -->
    <form method="get" style="margin-bottom: 1.5rem;">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:.75rem; align-items:end">
            <label>
                @Localizer["Status"]<br />
                <select class="input" name="FilterStatus" onchange="this.form.submit()">
                    <option value="0" selected="@(Model.FilterStatus == JoinRequestStatus.Pending)">@Localizer["Pending"]</option>
                    <option value="1" selected="@(Model.FilterStatus == JoinRequestStatus.Approved)">@Localizer["Approved"]</option>
                    <option value="2" selected="@(Model.FilterStatus == JoinRequestStatus.Rejected)">@Localizer["Rejected"]</option>
                </select>
            </label>

            <label>
                @Localizer["Company"]<br />
                <select class="input" name="FilterCompanyId" onchange="this.form.submit()">
                    <option value="">@Localizer["AllCompanies"]</option>
                    @foreach (var company in Model.AvailableCompanies)
                    {
                        <option value="@company.Id" selected="@(Model.FilterCompanyId == company.Id)">@company.Name</option>
                    }
                </select>
            </label>

            <label>
                @Localizer["Role"]<br />
                <select class="input" name="FilterRole" onchange="this.form.submit()">
                    <option value="">@Localizer["AllRoles"]</option>
                    <option value="2" selected="@(Model.FilterRole == UserRole.Employee)">@Localizer["Employee"]</option>
                    <option value="1" selected="@(Model.FilterRole == UserRole.Manager)">@Localizer["Manager"]</option>
                    <option value="3" selected="@(Model.FilterRole == UserRole.Director)">@Localizer["Director"]</option>
                    <option value="0" selected="@(Model.FilterRole == UserRole.Owner)">@Localizer["Owner"]</option>
                    <option value="4" selected="@(Model.FilterRole == UserRole.Trainee)">@Localizer["Trainee"]</option>
                </select>
            </label>

            @if (Model.FilterCompanyId.HasValue || Model.FilterRole.HasValue || Model.FilterStatus != JoinRequestStatus.Pending)
            {
                <a href="/Admin/Users" class="btn btn-ghost" style="align-self: end;">@Localizer["ClearFilters"]</a>
            }
        </div>
    </form>

    @if (Model.JoinRequests.Any())
    {
        <table>
            <thead>
                <tr>
                    <th>@Localizer["Submitted"]</th>
                    <th>@Localizer["Name"]</th>
                    <th>@Localizer["Email"]</th>
                    <th>@Localizer["Company"]</th>
                    <th>@Localizer["RequestedRole"]</th>
                    <th>@Localizer["Status"]</th>
                    <th style="width:1%">@Localizer["Actions"]</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var request in Model.JoinRequests)
            {
                <tr>
                    <td>@request.CreatedAt.ToLocalTime().ToString("MM/dd/yy HH:mm")</td>
                    <td>@request.DisplayName</td>
                    <td>@request.Email</td>
                    <td>@request.CompanyName</td>
                    <td>@request.RequestedRole</td>
                    <td>
                        @if (request.Status == JoinRequestStatus.Pending)
                        {
                            <span style="color: var(--warning, #ffc107)">⏳ @Localizer["Pending"]</span>
                        }
                        else if (request.Status == JoinRequestStatus.Approved)
                        {
                            <span style="color: var(--success, #28a745)">✓ @Localizer["Approved"]</span>
                        }
                        else
                        {
                            <span style="color: var(--danger, #dc3545)">✗ @Localizer["Rejected"]</span>
                        }
                    </td>
                    <td>
                        @if (request.Status == JoinRequestStatus.Pending)
                        {
                            <div style="display: flex; gap: 0.5rem; white-space: nowrap">
                                <form method="post" asp-page-handler="ApproveJoinRequest" style="display:inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@request.Id" />
                                    <button class="btn btn-success" type="submit" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                        ✓ @Localizer["Approve"]
                                    </button>
                                </form>
                                <form method="post" asp-page-handler="RejectJoinRequest" style="display:inline"
                                      onsubmit="return confirm('Reject this join request from @request.DisplayName?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@request.Id" />
                                    <button class="btn btn-danger" type="submit" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                                        ✗ @Localizer["Reject"]
                                    </button>
                                </form>
                            </div>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
    else
    {
        <p style="color: var(--muted); text-align: center; padding: 2rem;">
            @Localizer["NoJoinRequestsFound"]
        </p>
    }
</div>


<div class="card">
    <h3 style="margin-top:0">@Localizer["ExistingUsers"]</h3>

    <!-- Filters for users -->
    <form method="get" style="margin-bottom: 1.5rem;">
        <input type="hidden" name="FilterStatus" value="@((int)Model.FilterStatus)" />
        @if (Model.FilterCompanyId.HasValue)
        {
            <input type="hidden" name="FilterCompanyId" value="@Model.FilterCompanyId" />
        }
        @if (Model.FilterRole.HasValue)
        {
            <input type="hidden" name="FilterRole" value="@((int)Model.FilterRole.Value)" />
        }

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:.75rem; align-items:end">
            <label>
                @Localizer["Company"]<br />
                <select class="input" name="UserFilterCompanyId" onchange="this.form.submit()">
                    <option value="">@Localizer["AllCompanies"]</option>
                    @foreach (var company in Model.AvailableCompanies)
                    {
                        <option value="@company.Id" selected="@(Model.UserFilterCompanyId == company.Id)">@company.Name</option>
                    }
                </select>
            </label>

            <label>
                @Localizer["Role"]<br />
                <select class="input" name="UserFilterRole" onchange="this.form.submit()">
                    <option value="">@Localizer["AllRoles"]</option>
                    <option value="2" selected="@(Model.UserFilterRole == UserRole.Employee)">@Localizer["Employee"]</option>
                    <option value="1" selected="@(Model.UserFilterRole == UserRole.Manager)">@Localizer["Manager"]</option>
                    <option value="3" selected="@(Model.UserFilterRole == UserRole.Director)">@Localizer["Director"]</option>
                    <option value="0" selected="@(Model.UserFilterRole == UserRole.Owner)">@Localizer["Owner"]</option>
                    <option value="4" selected="@(Model.UserFilterRole == UserRole.Trainee)">@Localizer["Trainee"]</option>
                </select>
            </label>

            @if (Model.UserFilterCompanyId.HasValue || Model.UserFilterRole.HasValue)
            {
                <a href="/Admin/Users" class="btn btn-ghost" style="align-self: end;">@Localizer["ClearUserFilters"]</a>
            }
        </div>
    </form>

    <table>
        <thead><tr><th>@Localizer["Name"]</th><th>@Localizer["Email"]</th><th>@Localizer["Company"]</th><th>@Localizer["Role"]</th><th>@Localizer["Status"]</th><th style="width:1%">@Localizer["Password"]</th><th style="width:1%">@Localizer["Actions"]</th></tr></thead>
        <tbody>
        @foreach (var u in Model.Users)
        {
            <tr>
                <td>@u.DisplayName</td>
                <td>@u.Email</td>
                <td>@u.CompanyName</td>
                <td>
                    <form method="post" asp-page-handler="Role" style="display:inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@u.Id" />
                    <select class="input" name="role" onchange="this.form.submit()">
                    @foreach (var role in Model.AssignableRoles)
                    {
                        <option value="@role" selected="@(u.Role == role.ToString())">@Localizer[role.ToString()]</option>
                    }
                    </select>
                    </form>

                </td>
                <td>
                   <form method="post" asp-page-handler="Toggle" style="display:inline">
                   @Html.AntiForgeryToken()
                   <input type="hidden" name="id" value="@u.Id" />
                   <button class="btn">@((u.IsActive) ? Localizer["Active"] : Localizer["Inactive"])</button>
                   </form>
                </td>
                <td>
                    <form method="post" asp-page-handler="ResetPassword" style="display:inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@u.Id" />
                    <input class="input" type="password" name="newPassword" placeholder="new password" />
                    <button class="btn btn-ghost">@Localizer["Set"]</button>
                    </form>
                </td>
                <td>
                    <form method="post" asp-page-handler="DeleteUser" style="display:inline"
                          onsubmit="return confirm('⚠️ WARNING: This will permanently delete @u.DisplayName and remove all their shift assignments, time-off requests, and swap requests. This action cannot be undone.\n\nAre you absolutely sure you want to delete this user?');">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@u.Id" />
                        <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
                            🗑️ @Localizer["Delete"]
                        </button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <div style="margin-top: 1rem; padding: 1rem; background: var(--surface); border-left: 4px solid var(--danger); border-radius: 0.5rem;">
        <small style="color: var(--danger); font-weight: 600;">
            ⚠️ <strong>@Localizer["UserDeletionWarning"]</strong>
        </small>
        <br>
        <small style="color: var(--muted);">
            @Localizer["DeletingUserWillRemove"]
            • @Localizer["AllTheirShiftAssignments"]
            • @Localizer["AllTheirTimeOffRequests"]
            • @Localizer["AllTheirSwapRequests"]
            • @Localizer["TheUserAccountItself"]
            <br><br>
            <strong>@Localizer["ActionCannotBeUndone"]</strong>
        </small>
    </div>
</div>

<div class="card">
    <h3 style="margin-top:0">@Localizer["AddUser"]</h3>
    @if (!string.IsNullOrEmpty(Model.Error)) { <div class="small" style="color:var(--danger)">@Model.Error</div> }
    <form method="post" asp-page-handler="Add">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:.5rem; align-items:end">
            <label>@Localizer["Email"]<br /><input class="input" asp-for="NewEmail" /></label>
            <label>@Localizer["DisplayName"]<br /><input class="input" asp-for="NewDisplayName" /></label>
            <label>@Localizer["Role"]<br />
                <select class="input" asp-for="NewRole">
                    @foreach (var role in Model.AssignableRoles)
                    {
                        <option value="@role">@Localizer[role.ToString()]</option>
                    }
                </select>
            </label>
            <label>@Localizer["Password"]<br /><input class="input" asp-for="NewPassword" type="password" /></label>
            <button class="btn btn-primary" type="submit">@Localizer["Add"]</button>
        </div>
    </form>
</div>
