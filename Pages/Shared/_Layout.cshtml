@using System.Security.Claims
@using Microsoft.Extensions.Localization
@using ShiftManager.Models.Support
@using System.Globalization
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@inject IStringLocalizer<ShiftManager.Resources.SharedResources> Localizer
@{
    var user = HttpContextAccessor?.HttpContext?.User;
    var name = user?.FindFirst(ClaimTypes.Name)?.Value ?? "";
    var roleString = user?.FindFirst(ClaimTypes.Role)?.Value ?? "";
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("Manager");
    var firstName = name.Split(' ').FirstOrDefault() ?? name;

    // Get localized role name
    var role = "";
    if (Enum.TryParse<UserRole>(roleString, out var userRole))
    {
        role = userRole.GetDisplayName(Localizer);
    }

    // Get current culture for lang and dir attributes
    var currentCulture = CultureInfo.CurrentUICulture.Name;
    var isRtl = currentCulture == "he-IL";
    var lang = isRtl ? "he" : "en";
    var dir = isRtl ? "rtl" : "ltr";
}
<!DOCTYPE html>
<html lang="@lang" dir="@dir" data-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@(isAdmin ? Localizer["ShiftManager"] : $"{Localizer["MySchedule"]} - {firstName}")</title>
    <link rel="stylesheet" href="~/css/site.css" />
    <script defer src="~/js/site.js"></script>
</head>
<body>
<header class="@(isAdmin ? "topbar" : "topbar employee-topbar")">
    <div class="brand">
        @if (isAdmin)
        {
            <span>@Localizer["ShiftManager"]</span>
        }
        else
        {
            <div class="employee-brand">
                <span class="brand-icon">üìÖ</span>
                <div class="brand-text">
                    <div class="brand-title">@Localizer["MySchedule"]</div>
                    <div class="brand-subtitle">@string.Format(Localizer["WelcomeBack"], firstName)</div>
                </div>
            </div>
        }
    </div>

    <nav class="nav @(isAdmin ? "" : "employee-nav")">
        @if (isAdmin)
        {
            <div class="dropdown">
                <button class="linklike">@Localizer["Calendar"] ‚ñæ</button>
                <div class="menu">
                    <a href="/Calendar/Month">@Localizer["MonthView"]</a>
                    <a href="/Calendar/Week">@Localizer["WeekView"]</a>
                    <a href="/Calendar/Day">@Localizer["DayView"]</a>
                </div>
            </div>
            <a href="/Requests/Index">@Localizer["Requests"]</a>
            <a href="/My/Index">@Localizer["MyShifts"]</a>
            <div class="dropdown">
                <button class="linklike">@Localizer["Admin"] ‚ñæ</button>
                <div class="menu">
                    <a href="/Admin/Users">@Localizer["Users"]</a>
                    <a href="/Admin/ShiftTypes">@Localizer["ShiftTypes"]</a>
                    <a href="/Admin/TimeOff">@Localizer["TimeOffManagement"]</a>
                    <a href="/Admin/Config">@Localizer["Config"]</a>
                </div>
            </div>
        }
        else
        {
            <a href="/My/Index" class="nav-item primary">
                <span class="nav-icon">üè†</span>
                <span class="nav-text">@Localizer["MyShifts"]</span>
            </a>
            <a href="/Calendar/Month" class="nav-item">
                <span class="nav-icon">üìÖ</span>
                <span class="nav-text">@Localizer["Schedule"]</span>
            </a>
            <a href="/My/Requests" class="nav-item">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">@Localizer["Requests"]</span>
            </a>
            <a href="/My/NotificationCenter" class="nav-item notification-nav" style="position: relative;">
                <span class="nav-icon">üîî</span>
                <span class="nav-text">@Localizer["Notifications"]</span>
                @await Component.InvokeAsync("UnreadNotificationCount")
            </a>
        }
    </nav>

    <div class="spacer"></div>

    <div class="topbar-actions">
        <button class="action-btn" id="themeToggle" aria-label="Toggle dark mode">
            <span class="theme-icon">üåì</span>
        </button>

        <div class="dropdown">
            <button class="action-btn" aria-label="@Localizer["Language"]">
                <span>üåê</span>
            </button>
            <div class="menu" style="right: 0; min-width: 120px;">
                <a href="@Url.Page(null, null, new { culture = "en-US", uiculture = "en-US" })">@Localizer["English"]</a>
                <a href="@Url.Page(null, null, new { culture = "he-IL", uiculture = "he-IL" })">@Localizer["Hebrew"]</a>
            </div>
        </div>

        @if (User?.Identity?.IsAuthenticated == true)
        {
            <div class="user-menu">
                @if (!isAdmin)
                {
                    <div class="user-info">
                        <div class="user-avatar">@firstName.Substring(0, 1).ToUpper()</div>
                        <div class="user-details">
                            <div class="user-name">@name</div>
                            <div class="user-role">@role</div>
                        </div>
                    </div>
                }
                else
                {
                    <span class="admin-badge">@name (@role)</span>
                }
                <form method="post" asp-page="/Auth/Logout" style="display:inline">
                    @Html.AntiForgeryToken()
                    <button class="logout-btn" type="submit">
                        <span class="logout-icon">üö™</span>
                        <span class="logout-text">@Localizer["Logout"]</span>
                    </button>
                </form>
            </div>
        }
    </div>
</header>

@if (!isAdmin)
{
    var timeOfDay = DateTime.Now.Hour < 12 ? Localizer["GoodMorning"] : DateTime.Now.Hour < 18 ? Localizer["GoodAfternoon"] : Localizer["GoodEvening"];
    <div class="employee-welcome">
        <div class="container">
            <div class="welcome-content">
                <h1 class="welcome-title">@timeOfDay, @firstName!</h1>
                <p class="welcome-subtitle">@Localizer["ScheduleSubtitle"]</p>
            </div>
            <div class="quick-stats">
                <!-- Quick stats will be populated by individual pages -->
            </div>
        </div>
    </div>
}

<main class="@(isAdmin ? "container" : "container employee-container")">
    @RenderBody()
</main>

@await RenderSectionAsync("Scripts", required: false)
</body>
</html>
